<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vaulty - AI Car Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .animated-gradient {
            background: linear-gradient(-45deg, #00d4ff, #e81cff, #8f00ff, #ff00c8);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .nav-item:hover,
        .nav-item.active { color: #e81cff; }
        
        .page { display: none; }
        .page.active { display: block; }

        select:disabled, button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .gradient-border {
            position: relative;
            padding: 1px; /* Border width */
            background: linear-gradient(-45deg, #00d4ff, #e81cff, #8f00ff, #ff00c8);
            border-radius: 0.625rem; /* Slightly larger than inner rounded-lg */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <div class="w-screen h-screen bg-white dark:bg-black text-gray-900 dark:text-white flex flex-col">

        <!-- Top Header -->
        <header class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-800 flex-shrink-0">
            <h1 class="text-xl font-bold text-gray-800 dark:text-white tracking-tighter">Vaulty</h1>
            <button class="w-8 h-8 rounded-full overflow-hidden">
                <img src="https://placehold.co/100x100/e81cff/ffffff?text=U" alt="User profile picture">
            </button>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow overflow-y-auto no-scrollbar pb-24">
            <div class="w-full max-w-5xl mx-auto px-6 py-8">

                <!-- PAGE 1: HOME PAGE -->
                <div id="page-home" class="page active">
                    <div class="text-center">
                        <h2 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4">Welcome to Vaulty</h2>
                        <p class="text-gray-500 dark:text-gray-400 max-w-2xl mx-auto mb-8">Your AI hub for everything related to cars. Find data, compare models, and discover your next vehicle.</p>
                        <button data-page="page-tools" class="nav-link-btn animated-gradient text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300">
                            Start Searching
                        </button>
                    </div>

                    <div id="recent-cars-section" class="mt-16 text-left hidden">
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Recently Viewed</h3>
                        <div id="recent-cars-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <!-- Recently viewed cars will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- PAGE 2: TOOLS PAGE -->
                <div id="page-tools" class="page">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Tools</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Car Searcher Card -->
                        <div class="bg-gray-50 dark:bg-gray-800/50 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
                             <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">AI Vehicle Finder</h3>
                             <p class="text-gray-500 dark:text-gray-400 mb-6">Find detailed information about any vehicle.</p>
                             <div class="space-y-6">
                                <div>
                                    <label for="brand-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Brand</label>
                                    <select id="brand-select" class="w-full p-3 bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700 border rounded-lg focus:ring-violet-500 focus:border-violet-500 text-gray-900 dark:text-white">
                                        <option value="" disabled selected>Select a brand...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="model-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Model</label>
                                    <select id="model-select" class="w-full p-3 bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700 border rounded-lg focus:ring-violet-500 focus:border-violet-500 text-gray-900 dark:text-white" disabled>
                                        <option value="" disabled selected>First, select a brand</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="submodel-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sub-model / Trim</label>
                                    <select id="submodel-select" class="w-full p-3 bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700 border rounded-lg focus:ring-violet-500 focus:border-violet-500 text-gray-900 dark:text-white" disabled>
                                        <option value="" disabled selected>First, select a model</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="year-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Year</label>
                                    <select id="year-select" class="w-full p-3 bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700 border rounded-lg focus:ring-violet-500 focus:border-violet-500 text-gray-900 dark:text-white" disabled>
                                        <option value="" disabled selected>First, select a sub-model</option>
                                    </select>
                                </div>
                                <button id="search-btn" class="w-full animated-gradient text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300" disabled>
                                    Search Vehicle
                                </button>
                            </div>
                        </div>
                        
                        <!-- Dream Car Finder Card -->
                        <div class="bg-gray-50 dark:bg-gray-800/50 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Find Your Dream Car</h3>
                            <p class="text-gray-500 dark:text-gray-400 mb-6">Let AI find the perfect car for you. You don't have to fill all fields.</p>
                            <div class="space-y-6">
                                <div>
                                    <label for="type-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Car Type (Optional)</label>
                                    <select id="type-select" class="w-full p-3 bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700 border rounded-lg focus:ring-violet-500 focus:border-violet-500 text-gray-900 dark:text-white">
                                        <option value="">Any Type</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="budget-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max Budget (€) (Optional)</label>
                                    <input type="number" id="budget-input" placeholder="e.g., 25000" class="w-full p-3 bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700 border rounded-lg focus:ring-violet-500 focus:border-violet-500 text-gray-900 dark:text-white">
                                </div>
                                <div>
                                    <label for="brand-select-dream" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Brand (Optional)</label>
                                    <select id="brand-select-dream" class="w-full p-3 bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700 border rounded-lg focus:ring-violet-500 focus:border-violet-500 text-gray-900 dark:text-white">
                                        <option value="">Any Brand</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="year-select-dream" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Minimum Year (Optional)</label>
                                    <select id="year-select-dream" class="w-full p-3 bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700 border rounded-lg focus:ring-violet-500 focus:border-violet-500 text-gray-900 dark:text-white">
                                        <option value="">Any Year</option>
                                    </select>
                                </div>
                                <button id="find-dream-car-btn" class="w-full animated-gradient text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300">
                                    Find My Dream Car
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- PAGE 3: RESULTS PAGE -->
                <div id="page-results" class="page">
                    <button class="back-button-styled mb-6" data-target-page="page-tools">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                        <span>Back to Search</span>
                    </button>
                    <div id="results-content">
                        <div id="loading-indicator" class="flex items-center justify-center space-x-2 text-gray-500 dark:text-gray-400 py-10">
                            <svg class="animate-spin h-6 w-6 text-violet-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>AI is fetching vehicle data...</span>
                        </div>
                        <div id="ai-results-container" class="hidden">
                            <h2 id="result-title" class="text-3xl font-bold text-gray-900 dark:text-white"></h2>
                            <p id="result-origin" class="text-lg text-gray-500 dark:text-gray-400 mt-1 mb-6"></p>
                            <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- AI generated cards will be inserted here -->
                            </div>
                             <div id="broker-cta-container" class="mt-8 text-center">
                                <!-- Broker button will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PAGE 4: BROKER PAGE -->
                <div id="page-broker" class="page">
                     <button class="back-button-styled mb-6" data-target-page="page-results">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                        <span>Back to Vehicle Details</span>
                    </button>
                     <div id="broker-content">
                        <div id="broker-loading-indicator" class="flex items-center justify-center space-x-2 text-gray-500 dark:text-gray-400 py-10">
                            <svg class="animate-spin h-6 w-6 text-violet-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>AI Broker is preparing your offers...</span>
                        </div>
                        <div id="broker-results-container" class="hidden">
                            <!-- Broker results will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- PAGE 5: PROFILE PAGE -->
                <div id="page-profile" class="page text-center">
                    <img src="https://placehold.co/128x128/e81cff/ffffff?text=U" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-white dark:border-black shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">User Profile</h2>
                    <p class="text-gray-500 dark:text-gray-400 mt-2">This page is under construction.</p>
                </div>

                <!-- PAGE 6: DREAM CAR RESULTS -->
                <div id="page-dreamcar-results" class="page">
                    <button class="back-button-styled mb-6" data-target-page="page-tools">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                        <span>Back to Tools</span>
                    </button>
                    <div id="dreamcar-results-content">
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Your Top 3 Dream Car Matches</h2>
                        <div id="dreamcar-loading-indicator" class="flex items-center justify-center space-x-2 text-gray-500 dark:text-gray-400 py-10">
                            <svg class="animate-spin h-6 w-6 text-violet-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>AI is searching for your dream car...</span>
                        </div>
                        <div id="dreamcar-results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                            <!-- Dream car results will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="flex-shrink-0 bg-white/80 dark:bg-black/80 backdrop-blur-sm flex justify-center items-center space-x-12 z-50 fixed bottom-0 left-0 right-0 border-t border-gray-200 dark:border-gray-800 h-16">
            <button data-page="page-home" class="nav-item active text-gray-500 dark:text-gray-400 transition-colors duration-200 flex flex-col items-center justify-center w-20 h-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span class="text-xs mt-1">Home</span>
            </button>
            <button data-page="page-tools" class="nav-item text-gray-500 dark:text-gray-400 transition-colors duration-200 flex flex-col items-center justify-center w-20 h-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                <span class="text-xs mt-1">Tools</span>
            </button>
            <button data-page="page-profile" class="nav-item text-gray-500 dark:text-gray-400 transition-colors duration-200 flex flex-col items-center justify-center w-20 h-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span class="text-xs mt-1">Profile</span>
            </button>
        </nav>
    </div>

    <!-- Premium Modal -->
    <div id="premium-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="gradient-border max-w-md w-full mx-4">
            <div class="bg-white dark:bg-black rounded-lg p-8 text-center relative">
                <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <div class="animated-gradient w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15.5 13.5 3.5-3.5a2.1 2.1 0 1 0-3-3l-3.5 3.5a2.1 2.1 0 1 0 3 3z"></path><path d="M8.5 4.5 5 8a2.1 2.1 0 1 0 3 3l3.5-3.5a2.1 2.1 0 1 0-3-3z"></path><path d="m14 15.5 3.5 3.5a2.1 2.1 0 1 0 3-3l-3.5-3.5a2.1 2.1 0 1 0-3 3z"></path><path d="M4.5 8.5 8 5a2.1 2.1 0 1 0-3-3L1.5 5.5a2.1 2.1 0 1 0 3 3z"></path></svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Unlock Premium Features</h2>
                <p class="text-gray-500 dark:text-gray-400 mb-6">Get access to expert reviews, full AI analysis, AI broker services, and more.</p>
                <button class="w-full animated-gradient text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300">
                    Upgrade Now - $29.99/month
                </button>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- App State ---
    const isPremiumUser = false; // Set to true to see premium features unlocked

    // --- Car Data ---
    // Function to generate years for a range
    const generateYears = (start, end) => Array.from({ length: end - start + 1 }, (_, i) => end - i).map(String);
    const modernYears = (start) => generateYears(start, 2025);
    const classicYears = (start, end) => generateYears(start, end);

    const carData = {
        "Abarth": {
            "595": { "Turismo": modernYears(2018), "Competizione": modernYears(2018), "Esseesse": modernYears(2020) },
            "695": { "Biposto": classicYears(2014, 2016), "Rivale": ["2018"], "70th Anniversario": ["2020"] },
            "124 Spider": { "Scorpione": classicYears(2016, 2019), "GT": ["2018"] }
        },
        "Acura": {
            "Integra": { "GS-R": classicYears(1994, 2001), "Type R": classicYears(1997, 2001), "A-Spec": modernYears(2023), "Type S": modernYears(2024) },
            "MDX": { "A-Spec": modernYears(2019), "Type S": modernYears(2022) },
            "NSX": { "First Gen": classicYears(1991, 2005), "Second Gen": classicYears(2017, 2021), "Type S": ["2022"] },
            "RDX": { "A-Spec": modernYears(2019), "PMC Edition": ["2021"] },
            "TLX": { "A-Spec": modernYears(2021), "Type S": modernYears(2021) }
        },
        "Alfa Romeo": {
            "Giulia": { "Sprint": modernYears(2021), "Veloce": modernYears(2019), "Quadrifoglio": modernYears(2018) },
            "Stelvio": { "Super": modernYears(2020), "Veloce": modernYears(2021), "Quadrifoglio": modernYears(2020) },
            "Tonale": { "Veloce": modernYears(2023), "Sprint": modernYears(2023) },
            "4C": { "Coupe": classicYears(2015, 2019), "Spider": classicYears(2015, 2020) },
            "GTV6": { "2.5": classicYears(1981, 1987) }
        },
        "Alpine": {
            "A110": { "Pure": modernYears(2019), "Légende": modernYears(2019), "S": modernYears(2020) }
        },
        "Aston Martin": {
            "DB5": { "Standard": classicYears(1963, 1965) },
            "DB11": { "V8": modernYears(2019), "Volante": modernYears(2019), "AMR": modernYears(2020) },
            "DBS": { "Superleggera": modernYears(2019) },
            "Vantage": { "V8": modernYears(2020), "Roadster": modernYears(2021), "F1 Edition": modernYears(2022) },
            "DBX": { "V8": modernYears(2021), "707": modernYears(2022) }
        },
        "Audi": {
            "A1": { "Sportback 30 TFSI": modernYears(2019), "Citycarver": modernYears(2020) },
            "A3": { "8P": classicYears(2003, 2013), "8V": classicYears(2012, 2020), "Sportback 35 TFSI (8Y)": modernYears(2020), "S3 Sportback (8Y)": modernYears(2021), "RS3 Sportback (8Y)": modernYears(2022) },
            "A4": { "B8": classicYears(2008, 2016), "B9 Sedan 40 TFSI": modernYears(2020), "B9 Avant 40 TDI": modernYears(2019), "B9 Allroad": modernYears(2020), "S4 Avant (B9)": modernYears(2020), "RS4 Avant (B9)": modernYears(2020) },
            "A5": { "Coupe 45 TFSI": modernYears(2020), "Sportback S line": modernYears(2021), "S5 Sportback": modernYears(2020), "RS5 Coupe": modernYears(2020) },
            "A6": { "C7": classicYears(2011, 2018), "C8 Sedan 55 TFSI": modernYears(2019), "C8 Avant 55 TFSI": modernYears(2019), "C8 Allroad": modernYears(2020), "S6 Avant (C8)": modernYears(2020), "RS6 Avant (C8)": modernYears(2020) },
            "A7": { "Sportback 55 TFSI": modernYears(2019), "S7 Sportback": modernYears(2020), "RS7 Sportback": modernYears(2020) },
            "A8": { "L 60 TFSI": modernYears(2019), "S8": modernYears(2020) },
            "Q2": { "35 TFSI": modernYears(2019), "SQ2": modernYears(2020) },
            "Q3": { "Sportback 45 TFSI": modernYears(2020), "RS Q3 Sportback": modernYears(2021) },
            "Q5": { "45 TFSI": modernYears(2018), "Sportback": modernYears(2021), "SQ5": modernYears(2019) },
            "Q7": { "4L": classicYears(2005, 2015), "4M 55 TFSI": modernYears(2020), "SQ7 (4M)": modernYears(2021) },
            "Q8": { "55 TFSI": modernYears(2019), "SQ8": modernYears(2020), "RS Q8": modernYears(2020) },
            "R8": { "Type 42": classicYears(2006, 2015), "V10 RWD": modernYears(2021), "V10 Performance": modernYears(2019), "Spyder": modernYears(2020) },
            "TT": { "Mk1": classicYears(1998, 2006), "Mk2": classicYears(2006, 2014), "Mk3 Coupe 45 TFSI": modernYears(2019), "TTS Roadster": modernYears(2020), "TT RS Coupe": modernYears(2020) },
            "e-tron GT": { "quattro": modernYears(2022), "RS e-tron GT": modernYears(2022) },
            "Q4 e-tron": { "50 quattro": modernYears(2022), "Sportback": modernYears(2022) },
            "Sport Quattro": { "S1": classicYears(1984, 1985) }
        },
        "Bentley": {
            "Continental GT": { "W12": modernYears(2019), "V8": modernYears(2020), "Speed": modernYears(2022), "Mulliner": modernYears(2021) },
            "Flying Spur": { "W12": modernYears(2020), "V8": modernYears(2021), "Hybrid": modernYears(2022) },
            "Bentayga": { "V8": modernYears(2019), "Speed": modernYears(2021), "Hybrid": modernYears(2021), "EWB": modernYears(2023) }
        },
        "BMW": {
            "1 Series": { "E87": classicYears(2004, 2011), "F20": classicYears(2011, 2019), "F40 118i": modernYears(2019), "128ti": modernYears(2021), "M135i xDrive": modernYears(2020), "1M Coupe": ["2011", "2012"] },
            "2 Series": { "F22 220i Coupe": modernYears(2022), "M240i xDrive": modernYears(2022), "F45 Gran Coupe": modernYears(2020), "U06 Active Tourer": modernYears(2022) },
            "3 Series": { "E46": classicYears(1998, 2006), "E90": classicYears(2005, 2011), "F30": classicYears(2012, 2018), "G20 320d": modernYears(2019), "330e": modernYears(2020), "M340i xDrive": modernYears(2020), "G21 Touring": modernYears(2020) },
            "4 Series": { "F32": classicYears(2014, 2020), "G22 420i Coupe": modernYears(2021), "M440i xDrive": modernYears(2021), "Gran Coupe": modernYears(2022), "Convertible": modernYears(2021) },
            "5 Series": { "E39": classicYears(1995, 2004), "E60": classicYears(2003, 2010), "F10": classicYears(2010, 2017), "G30 520d": modernYears(2017), "540i": modernYears(2018), "545e xDrive": modernYears(2021), "G31 Touring": modernYears(2018) },
            "6 Series": { "E63": classicYears(2003, 2010), "F13": classicYears(2011, 2018), "G32 Gran Turismo": classicYears(2018, 2023) },
            "7 Series": { "E65": classicYears(2001, 2008), "F01": classicYears(2008, 2015), "G11 740d xDrive": modernYears(2020), "G70 750e xDrive": modernYears(2023), "i7 xDrive60": modernYears(2023) },
            "8 Series": { "E31": classicYears(1990, 1999), "G15 840i Gran Coupe": modernYears(2020), "M850i xDrive Coupe": modernYears(2019) },
            "X1": { "E84": classicYears(2009, 2015), "F48": classicYears(2015, 2022), "U11 xDrive23i": modernYears(2022), "iX1": modernYears(2023) },
            "X2": { "F39 M35i": modernYears(2020) },
            "X3": { "E83": classicYears(2003, 2010), "F25": classicYears(2010, 2017), "G01 xDrive20d": modernYears(2018), "M40i": modernYears(2019), "iX3": modernYears(2022) },
            "X4": { "F26": classicYears(2014, 2018), "G02 xDrive30d": modernYears(2019), "M40i": modernYears(2020) },
            "X5": { "E53": classicYears(1999, 2006), "E70": classicYears(2006, 2013), "F15": classicYears(2013, 2018), "G05 xDrive40d": modernYears(2019), "M60i": modernYears(2023), "xDrive45e": modernYears(2020) },
            "X6": { "E71": classicYears(2008, 2014), "F16": classicYears(2014, 2019), "G06 xDrive40d": modernYears(2020), "M60i": modernYears(2023) },
            "X7": { "M60i": modernYears(2023), "xDrive40d": modernYears(2021) },
            "Z4": { "E85": classicYears(2002, 2008), "E89": classicYears(2009, 2016), "G29 sDrive30i": modernYears(2019), "M40i": modernYears(2019) },
            "i4": { "eDrive40": modernYears(2022), "M50": modernYears(2022) },
            "iX": { "xDrive50": modernYears(2022), "M60": modernYears(2023) },
            "M2": { "F87 Competition": classicYears(2018, 2021), "G87": modernYears(2023) },
            "M3": { "E30": classicYears(1986, 1991), "E36": classicYears(1992, 1999), "E46": classicYears(2000, 2006), "E92": classicYears(2007, 2013), "F80": classicYears(2014, 2018), "G80 Competition": modernYears(2021), "G81 Touring": modernYears(2023) },
            "M4": { "F82 Competition": classicYears(2016, 2020), "G82 Competition": modernYears(2021), "CSL": ["2023"] },
            "M5": { "E39": classicYears(1998, 2003), "E60": classicYears(2005, 2010), "F90 Competition": modernYears(2018) },
            "M8": { "Competition Coupe": modernYears(2020), "Competition Gran Coupe": modernYears(2020) },
            "X3 M": { "Competition": modernYears(2020) },
            "X5 M": { "Competition": modernYears(2020) },
            "X6 M": { "Competition": modernYears(2020) }
        },
        "Bugatti": {
            "Veyron": { "16.4": classicYears(2005, 2011), "Super Sport": classicYears(2010, 2011) },
            "Chiron": { "Standard": modernYears(2017), "Sport": modernYears(2019), "Pur Sport": modernYears(2021), "Super Sport 300+": modernYears(2021) },
            "Divo": { "Standard": ["2020", "2021"] },
            "Centodieci": { "Standard": ["2022"] }
        },
        "Cadillac": {
            "CT5-V": { "Blackwing": modernYears(2022) },
            "Escalade": { "ESV": modernYears(2021), "V-Series": modernYears(2023) },
            "Lyriq": { "Debut Edition": modernYears(2023) }
        },
        "Chevrolet": {
            "Camaro": { "SS": modernYears(2018), "ZL1 1LE": modernYears(2019) },
            "Corvette": { "C6 Z06": classicYears(2006, 2013), "C7 Stingray": classicYears(2014, 2019), "C8 Stingray": modernYears(2020), "C8 Z06": modernYears(2023), "E-Ray": modernYears(2024) },
            "Silverado": { "1500 RST": modernYears(2020), "ZR2": modernYears(2022) },
            "Tahoe": { "Z71": modernYears(2021) }
        },
        "Citroën": {
            "C3": { "Gen 2": classicYears(2009, 2016), "Gen 3 Shine": modernYears(2017) },
            "C5 Aircross": { "Shine Pack": modernYears(2021) },
            "DS3": { "Sport Chic": classicYears(2010, 2015) }
        },
        "Dodge": {
            "Challenger": { "SRT Hellcat": modernYears(2019), "SRT Demon": ["2018"], "SRT Demon 170": ["2023"] },
            "Charger": { "SRT Hellcat Widebody": modernYears(2020) },
            "Durango": { "SRT Hellcat": ["2021", "2023"] },
            "Viper": { "ACR": ["2016", "2017"] }
        },
        "Ferrari": {
            "296": { "GTB": modernYears(2022), "GTS": modernYears(2023) },
            "SF90": { "Stradale": modernYears(2020), "Spider": modernYears(2021) },
            "812": { "Superfast": classicYears(2017, 2023), "GTS": modernYears(2020), "Competizione": ["2022"] },
            "F8": { "Tributo": classicYears(2020, 2023), "Spider": classicYears(2020, 2023) },
            "Roma": { "Standard": modernYears(2021) },
            "Purosangue": { "Standard": modernYears(2023) },
            "Monza": { "SP1": ["2019"], "SP2": ["2019"] },
            "LaFerrari": { "Coupé": ["2014", "2015", "2016"], "Aperta": ["2017", "2018"] },
            "Enzo": { "Standard": classicYears(2002, 2004) },
            "F40": { "Standard": classicYears(1987, 1992) },
            "F50": { "Standard": classicYears(1995, 1997) },
            "Testarossa": { "Standard": classicYears(1984, 1991) }
        },
        "Fiat": {
            "500": { "Lounge": modernYears(2018), "Electric": modernYears(2021) },
            "Panda": { "Cross": modernYears(2019) }
        },
        "Ford": {
            "Fiesta": { "ST (Mk7)": classicYears(2013, 2017), "ST (Mk8)": classicYears(2018, 2023) },
            "Focus": { "ST (Mk3)": classicYears(2012, 2018), "RS (Mk3)": classicYears(2016, 2018), "ST (Mk4)": modernYears(2019) },
            "Mustang": { "GT (S197)": classicYears(2005, 2014), "GT (S550)": modernYears(2018), "Mach 1": modernYears(2021), "Shelby GT350": classicYears(2016, 2020), "Shelby GT500": modernYears(2020), "Dark Horse": modernYears(2024) },
            "GT": { "Standard": classicYears(2017, 2022) },
            "Bronco": { "Raptor": modernYears(2022), "Badlands": modernYears(2021) },
            "F-150": { "Raptor": modernYears(2021), "Lightning": modernYears(2022) },
            "Puma": { "ST": modernYears(2021) }
        },
        "Genesis": {
            "G70": { "3.3T Sport": modernYears(2020) },
            "G80": { "2.5T": modernYears(2021) },
            "GV80": { "3.5T Prestige": modernYears(2021) }
        },
        "Honda": {
            "Civic": { "Si (9th Gen)": classicYears(2012, 2015), "Type R (FK2)": classicYears(2015, 2016), "Type R (FK8)": classicYears(2017, 2021), "Si (11th Gen)": modernYears(2022), "Type R (FL5)": modernYears(2023) },
            "Accord": { "Sport 2.0T": classicYears(2018, 2022) },
            "CR-V": { "Hybrid": modernYears(2020) },
            "NSX": { "Second Gen": classicYears(2016, 2022) },
            "S2000": { "AP1": classicYears(2000, 2003), "AP2": classicYears(2004, 2009) }
        },
        "Hyundai": {
            "i20 N": { "Performance": modernYears(2021) },
            "i30 N": { "Performance": modernYears(2021) },
            "Kona N": { "Standard": modernYears(2022) },
            "Ioniq 5": { "N": modernYears(2024), "Ultimate": modernYears(2022) }
        },
        "Jaguar": {
            "F-Type": { "R Coupe": modernYears(2021), "P450 Convertible": modernYears(2022) },
            "F-Pace": { "SVR": modernYears(2021) },
            "I-Pace": { "HSE": modernYears(2020) },
            "XJ": { "X351": classicYears(2010, 2019) }
        },
        "Jeep": {
            "Wrangler": { "Rubicon 392": modernYears(2021), "4xe": modernYears(2022) },
            "Grand Cherokee": { "Trackhawk": classicYears(2018, 2021), "L Summit": modernYears(2022) }
        },
        "Kia": {
            "Stinger": { "GT2": modernYears(2022) },
            "Telluride": { "SX": modernYears(2021) },
            "EV6": { "GT": modernYears(2023), "GT-Line": modernYears(2022) }
        },
        "Koenigsegg": {
            "Agera": { "RS": classicYears(2015, 2018) },
            "Regera": { "Standard": classicYears(2016, 2022) },
            "Jesko": { "Absolut": modernYears(2022) },
            "Gemera": { "Standard": modernYears(2024) }
        },
        "Lamborghini": {
            "Huracan": { "EVO RWD": modernYears(2020), "STO": modernYears(2021), "Tecnica": modernYears(2023), "Sterrato": modernYears(2023) },
            "Aventador": { "S": classicYears(2017, 2021), "SVJ": classicYears(2018, 2021), "Ultimae": ["2022"] },
            "Urus": { "Standard": modernYears(2019), "Performante": modernYears(2023) },
            "Revuelto": { "Standard": modernYears(2024) },
            "Countach": { "LP400": classicYears(1974, 1978), "LPI 800-4": ["2022"] },
            "Diablo": { "VT": classicYears(1993, 1998) },
            "Murciélago": { "LP 670–4 SuperVeloce": ["2009", "2010"] }
        },
        "Lancia": {
            "Delta": { "Integrale Evoluzione II": ["1993", "1994"] },
            "Stratos": { "HF Stradale": classicYears(1973, 1978) }
        },
        "Land Rover": {
            "Defender": { "110 V8": modernYears(2021), "90": modernYears(2021) },
            "Range Rover": { "Autobiography": modernYears(2022), "SV": modernYears(2023) },
            "Range Rover Sport": { "SVR": classicYears(2018, 2022), "P530 First Edition": modernYears(2023) }
        },
        "Lexus": {
            "IS": { "500 F Sport Performance": modernYears(2022) },
            "LC": { "500": modernYears(2018) },
            "RC F": { "Fuji Speedway Edition": modernYears(2021) },
            "LFA": { "Nürburgring Package": ["2012"] }
        },
        "Maserati": {
            "MC20": { "Cielo": modernYears(2023), "Coupe": modernYears(2022) },
            "Grecale": { "Trofeo": modernYears(2023) },
            "GranTurismo": { "Trofeo": modernYears(2024) }
        },
        "Mazda": {
            "MX-5": { "NA": classicYears(1990, 1997), "NB": classicYears(1998, 2005), "NC": classicYears(2006, 2015), "ND RF Club": modernYears(2019) },
            "CX-5": { "Turbo Signature": modernYears(2021) },
            "RX-7": { "FD Spirit R": ["2002"] },
            "RX-8": { "R3": classicYears(2009, 2011) }
        },
        "McLaren": {
            "720S": { "Spider": modernYears(2019), "Coupe": classicYears(2017, 2023) },
            "765LT": { "Spider": ["2022"], "Coupe": ["2021"] },
            "Artura": { "Standard": modernYears(2023) },
            "GT": { "Standard": modernYears(2020) },
            "Senna": { "Standard": ["2019"] },
            "P1": { "Standard": ["2013", "2014", "2015"] },
            "F1": { "Standard": classicYears(1992, 1998) }
        },
        "Mercedes-Benz": {
            "A-Class": { "W176": classicYears(2013, 2018), "W177 A 250": modernYears(2019), "AMG A 35": modernYears(2020), "AMG A 45 S": modernYears(2020) },
            "C-Class": { "W204": classicYears(2007, 2014), "W205 C 300": modernYears(2022), "AMG C 43": modernYears(2023), "AMG C 63 S (W205)": classicYears(2017, 2021), "AMG C 63 S E Performance": modernYears(2024) },
            "E-Class": { "W212": classicYears(2010, 2016), "W213 E 450": modernYears(2021), "AMG E 53": modernYears(2021), "AMG E 63 S": modernYears(2021) },
            "S-Class": { "W222": classicYears(2014, 2020), "W223 S 580": modernYears(2021), "Maybach S 680": modernYears(2022) },
            "CLA": { "AMG 45 S": modernYears(2020) },
            "CLS": { "AMG 53": modernYears(2019) },
            "G-Class": { "G 500": modernYears(2019), "AMG G 63": modernYears(2019), "AMG G 63 4x4²": modernYears(2023) },
            "GLA": { "AMG 45 S": modernYears(2021) },
            "GLC": { "AMG 63 S Coupe": modernYears(2020) },
            "GLE": { "AMG 63 S Coupe": modernYears(2021) },
            "SL": { "R231": classicYears(2012, 2020), "R232 AMG 63": modernYears(2022) },
            "AMG GT": { "GT C Roadster": modernYears(2020), "GT R": classicYears(2017, 2021), "Black Series": ["2021"] },
            "SLS AMG": { "Black Series": ["2014"] },
            "300 SL": { "Gullwing": classicYears(1954, 1957) }
        },
        "Mitsubishi": {
            "Lancer Evolution": { "VIII": classicYears(2003, 2005), "IX MR": ["2006"], "X Final Edition": ["2015"] }
        },
        "Nissan": {
            "GT-R": { "R35 Premium": modernYears(2017), "Nismo": modernYears(2020) },
            "Z": { "370Z Nismo": classicYears(2015, 2020), "Proto Spec": ["2023"], "Performance": modernYears(2023) },
            "Silvia": { "S13": classicYears(1989, 1994), "S14": classicYears(1995, 1998), "S15 Spec-R": classicYears(1999, 2002) },
            "Skyline GT-R": { "R32": classicYears(1989, 1994), "R33": classicYears(1995, 1998), "R34 V-Spec II Nür": ["2002"] }
        },
        "Pagani": {
            "Zonda": { "Cinque": ["2009"] },
            "Huayra": { "BC Roadster": modernYears(2020) },
            "Utopia": { "Standard": modernYears(2023) }
        },
        "Peugeot": {
            "208": { "GT": modernYears(2020) },
            "3008": { "GT Hybrid4": modernYears(2021) },
            "205": { "GTI 1.9": classicYears(1987, 1992) }
        },
        "Polestar": {
            "1": { "Standard": classicYears(2020, 2022) },
            "2": { "Long Range Dual Motor": modernYears(2021) }
        },
        "Porsche": {
            "718": { "Cayman S": modernYears(2017), "Boxster GTS 4.0": modernYears(2020), "Cayman GT4 RS": modernYears(2022), "Spyder RS": modernYears(2024) },
            "911": {
                "997 Carrera": classicYears(2005, 2012), "991 Carrera": classicYears(2012, 2019), "992 Carrera": modernYears(2020), "992 Carrera S": modernYears(2020), "992 GTS": modernYears(2022), "992 Targa 4S": modernYears(2021),
                "992 Turbo S": modernYears(2021), "992 GT3": modernYears(2022), "992 GT3 RS": modernYears(2023), "Dakar": ["2023"], "S/T": ["2024"],
                "930 Turbo": classicYears(1975, 1989), "964 Carrera RS": ["1992"], "993 GT2": ["1995"], "997 GT3 RS 4.0": ["2011"]
            },
            "Taycan": { "4S": modernYears(2020), "Turbo S": modernYears(2020), "Cross Turismo": modernYears(2022) },
            "Panamera": { "Turbo S E-Hybrid": modernYears(2021) },
            "Cayenne": { "S": modernYears(2019), "Turbo GT": modernYears(2022) },
            "Macan": { "GTS": modernYears(2022) },
            "918 Spyder": { "Weissach Package": ["2015"] },
            "Carrera GT": { "Standard": classicYears(2004, 2006) }
        },
        "Renault": {
            "Megane R.S.": { "Trophy-R": ["2020"], "Ultime": ["2023"] },
            "Clio V6": { "Phase 2": classicYears(2003, 2005) }
        },
        "Rimac": {
            "Nevera": { "Standard": modernYears(2022) }
        },
        "Rolls-Royce": {
            "Phantom": { "EWB": modernYears(2018) },
            "Cullinan": { "Black Badge": modernYears(2020) },
            "Ghost": { "Black Badge": modernYears(2022) }
        },
        "Subaru": {
            "WRX": { "STI (VA)": classicYears(2015, 2021), "STI S209": ["2019"], "New Gen (VB)": modernYears(2022) },
            "BRZ": { "Limited": modernYears(2022) },
            "Impreza": { "22B STI": ["1998"] }
        },
        "Tesla": {
            "Model 3": { "Performance": modernYears(2020), "Long Range": modernYears(2021) },
            "Model S": { "Plaid": modernYears(2021), "Long Range": modernYears(2021) },
            "Model X": { "Plaid": modernYears(2021), "Long Range": modernYears(2021) },
            "Model Y": { "Performance": modernYears(2021), "Long Range": modernYears(2021) }
        },
        "Toyota": {
            "Supra": { "Mk4 Twin Turbo": classicYears(1993, 2002), "GR 3.0 (A90)": modernYears(2020), "A91-MT Edition": ["2023"] },
            "GR Yaris": { "Circuit Pack": modernYears(2021) },
            "GR86": { "Premium": modernYears(2022) },
            "GR Corolla": { "Circuit Edition": ["2023"] },
            "Land Cruiser": { "Series 300": modernYears(2022) },
            "AE86": { "Sprinter Trueno": classicYears(1983, 1987) }
        },
        "Volkswagen": {
            "Golf": { "Mk5 GTI": classicYears(2004, 2008), "Mk6 R": classicYears(2010, 2013), "Mk7 GTI": classicYears(2013, 2020), "Mk7 R": classicYears(2014, 2020), "Mk8 GTI": modernYears(2021), "Mk8 R": modernYears(2022), "GTI Clubsport": modernYears(2021) },
            "Polo": { "GTI": modernYears(2022) },
            "T-Roc": { "R": modernYears(2021) },
            "ID.4": { "GTX": modernYears(2022) }
        },
        "Volvo": {
            "XC90": { "T8 Recharge": modernYears(2021) },
            "S60": { "T8 Polestar Engineered": modernYears(2020) }
        }
    };

    const brandSelect = document.getElementById('brand-select');
    const modelSelect = document.getElementById('model-select');
    const submodelSelect = document.getElementById('submodel-select');
    const yearSelect = document.getElementById('year-select');
    const searchBtn = document.getElementById('search-btn');
    const backBtn = document.getElementById('back-btn');
    const backToResultsBtn = document.getElementById('back-to-results-btn');

    
    const navItems = document.querySelectorAll('.nav-item');
    const navLinkBtns = document.querySelectorAll('.nav-link-btn');
    const pages = document.querySelectorAll('.page');
    
    const loadingIndicator = document.getElementById('loading-indicator');
    const aiResultsContainer = document.getElementById('ai-results-container');
    const resultsGrid = document.getElementById('results-grid');
    const resultTitle = document.getElementById('result-title');
    const resultOrigin = document.getElementById('result-origin');
    const brokerCtaContainer = document.getElementById('broker-cta-container');

    const brokerLoadingIndicator = document.getElementById('broker-loading-indicator');
    const brokerResultsContainer = document.getElementById('broker-results-container');

    const recentCarsSection = document.getElementById('recent-cars-section');
    const recentCarsGrid = document.getElementById('recent-cars-grid');
    const MAX_RECENT_CARS = 5;

    // --- Dream Car Finder Elements ---
    const typeSelect = document.getElementById('type-select');
    const budgetInput = document.getElementById('budget-input');
    const brandSelectDream = document.getElementById('brand-select-dream');
    const yearSelectDream = document.getElementById('year-select-dream');
    const findDreamCarBtn = document.getElementById('find-dream-car-btn');
    const backToToolsBtn = document.getElementById('back-to-tools-btn');
    const dreamcarLoadingIndicator = document.getElementById('dreamcar-loading-indicator');
    const dreamcarResultsGrid = document.getElementById('dreamcar-results-grid');


    let currentCar = {};
    const countryCodeMap = { 'Germany': 'DE', 'USA': 'US', 'United Kingdom': 'GB', 'Japan': 'JP', 'Italy': 'IT', 'France': 'FR', 'Sweden': 'SE', 'South Korea': 'KR', 'Spain': 'ES', 'Czech Republic': 'CZ', 'Romania': 'RO' };

    
    // --- Navigation Logic ---
    function switchPage(pageId) {
        window.scrollTo(0, 0);
        pages.forEach(page => page.classList.remove('active'));
        
        const activePage = document.getElementById(pageId);
        if (activePage) activePage.classList.add('active');

        // Only update nav items if it's a main page
        if (['page-home', 'page-tools', 'page-profile'].includes(pageId)) {
            navItems.forEach(item => item.classList.remove('active'));
            const activeNavItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
            if (activeNavItem) activeNavItem.classList.add('active');
        }
    }

    navItems.forEach(item => item.addEventListener('click', () => switchPage(item.dataset.page)));
    navLinkBtns.forEach(item => item.addEventListener('click', () => switchPage(item.dataset.page)));

    // --- Search Form Logic ---
    const brands = Object.keys(carData).sort();
    brands.forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandSelect.appendChild(option);
    });

    brandSelect.addEventListener('change', () => {
        const selectedBrand = brandSelect.value;
        modelSelect.innerHTML = '<option value="" disabled selected>Select a model...</option>';
        submodelSelect.innerHTML = '<option value="" disabled selected>First, select a model</option>';
        yearSelect.innerHTML = '<option value="" disabled selected>First, select a sub-model</option>';
        
        modelSelect.disabled = !selectedBrand;
        submodelSelect.disabled = true;
        yearSelect.disabled = true;
        searchBtn.disabled = true;

        if (selectedBrand && carData[selectedBrand]) {
            const models = Object.keys(carData[selectedBrand]).sort();
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
        }
    });

    modelSelect.addEventListener('change', () => {
        const selectedBrand = brandSelect.value;
        const selectedModel = modelSelect.value;
        submodelSelect.innerHTML = '<option value="" disabled selected>Select a sub-model...</option>';
        yearSelect.innerHTML = '<option value="" disabled selected>First, select a sub-model</option>';
        
        submodelSelect.disabled = !selectedModel;
        yearSelect.disabled = true;
        searchBtn.disabled = true;

        if (selectedBrand && selectedModel && carData[selectedBrand][selectedModel]) {
            const submodels = Object.keys(carData[selectedBrand][selectedModel]).sort();
            submodels.forEach(submodel => {
                const option = document.createElement('option');
                option.value = submodel;
                option.textContent = submodel;
                submodelSelect.appendChild(option);
            });
        }
    });

    submodelSelect.addEventListener('change', () => {
        const selectedBrand = brandSelect.value;
        const selectedModel = modelSelect.value;
        const selectedSubmodel = submodelSelect.value;
        yearSelect.innerHTML = '<option value="" disabled selected>Select a year...</option>';

        yearSelect.disabled = !selectedSubmodel;
        searchBtn.disabled = true;
        
        if (selectedBrand && selectedModel && selectedSubmodel && carData[selectedBrand][selectedModel][selectedSubmodel]) {
            const years = carData[selectedBrand][selectedModel][selectedSubmodel].sort((a, b) => b - a);
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }
    });

    yearSelect.addEventListener('change', () => searchBtn.disabled = !yearSelect.value);
    
    searchBtn.addEventListener('click', () => {
        currentCar = {
            brand: brandSelect.value,
            model: modelSelect.value,
            submodel: submodelSelect.value,
            year: yearSelect.value,
        };
        searchVehicle(currentCar);
    });
    
    document.querySelectorAll('.back-button-styled').forEach(button => {
        button.addEventListener('click', (e) => {
            const targetPage = e.currentTarget.dataset.targetPage;
            if(targetPage) {
                switchPage(targetPage);
            }
        });
    });


    async function searchVehicle(car) {
        if (!car.brand || !car.model || !car.submodel || !car.year) {
            alert("Please select a brand, model, sub-model, and year.");
            return;
        }

        switchPage('page-results');
        loadingIndicator.style.display = 'flex';
        aiResultsContainer.classList.add('hidden');
        resultsGrid.innerHTML = '';
        brokerCtaContainer.innerHTML = '';
        
        const prompt = `Act as a car expert. Provide detailed information for the vehicle: ${car.brand} ${car.model} ${car.submodel} (${car.year}).

VERY IMPORTANT: Your response MUST be a single, valid JSON object without any surrounding text or markdown. The JSON object must have the following structure:
{
  "short_title": "A short, common name for the car, e.g., 'Mercedes A35 AMG'.",
  "description": "A brief overview of the vehicle (string).",
  "expert_review": "A detailed expert review covering driving experience, interior, and reliability (string).",
  "price": { "new_eur": "e.g., '€85,000'", "used_eur": "e.g., '€60,000 - €75,000'" },
  "performance": { "power_hp": "e.g., '450'", "top_speed_kmh": "e.g., '290'", "acceleration_sec": "e.g., '4.1'" },
  "origin": "Country of origin (string).",
  "rating": "Expert rating out of 5, e.g., '4.7' (string).",
  "colors": [
    { "name": "Nardo Gray", "hex": "#8a8d8f" }, { "name": "Mythos Black", "hex": "#1c1c1c" }, { "name": "Tango Red", "hex": "#c50000" }
  ],
  "price_history": [
    { "year": "${parseInt(car.year)}", "price_eur": "e.g., '€65,000'" }, { "year": "${parseInt(car.year) - 1}", "price_eur": "e.g., '€62,000'" }, { "year": "${parseInt(car.year) - 2}", "price_eur": "e.g., '€58,000'" }
  ],
  "modifications": [
    { "name": "Akrapovič Exhaust System", "description": "Titanium exhaust that reduces weight and enhances the engine's sound." }, { "name": "KW Coilover Suspension", "description": "Adjustable suspension for improved handling and lower ride height." }
  ],
  "part_prices": {
    "tire_eur": "e.g., '€250 - €400'", "brake_pads_eur": "e.g., '€150 - €250'"
  },
   "full_analysis": {
    "common_faults": "List common mechanical or electrical issues for this model and year.",
    "maintenance_tips": "Provide key maintenance tips to keep the car in good shape.",
    "service_contacts": "Suggest generic types of specialists to contact for issues, e.g., 'Certified brand mechanic', 'Independent European car specialist'."
  },
  "tuning_versions": [
    {
      "tuner": "e.g., 'ABT Sportsline'",
      "model_name": "e.g., 'ABT RS6-R'",
      "description": "A brief summary of the tuning package, highlighting key improvements like power increase, new body kit, etc."
    }
  ]
}
If a piece of information is not available, return "N/A" for strings, empty arrays [] for lists, or empty objects {} for maps. For "tuning_versions", return an empty array [] if no well-known tuners (like ABT, Brabus, Mansory, Hennessey, etc.) exist for this specific model.`;

        const result = await callGeminiAPI(prompt, searchBtn);
        
        saveRecentCar(car);
        displayRecentCars();

        try {
            const data = JSON.parse(result);
            resultTitle.textContent = `${data.short_title || `${car.brand} ${car.model} ${car.submodel}`} (${car.year})`;
            displayResultsAsCards(data);
        } catch (e) {
            console.error("Failed to parse AI response as JSON:", e, "Response was:", result);
            resultTitle.textContent = `${car.brand} ${car.model} ${car.submodel} (${car.year})`;
            resultsGrid.innerHTML = `<div class="col-span-1 md:col-span-2 p-4 bg-red-900/20 text-red-300 border border-red-500 rounded-lg">An error occurred while displaying the data. The AI returned an invalid format.</div>`;
        }
        
        loadingIndicator.style.display = 'none';
        aiResultsContainer.classList.remove('hidden');
    }

    async function findBroker(car) {
        switchPage('page-broker');
        brokerLoadingIndicator.style.display = 'flex';
        brokerResultsContainer.classList.add('hidden');
        brokerResultsContainer.innerHTML = '';

        const prompt = `Act as an expert AI car broker from a premium fictional company called 'Quantum Auto Finance'. A client is looking for insurance and financing options for a ${car.year} ${car.brand} ${car.model} ${car.submodel}.

VERY IMPORTANT: Your response MUST be a single, valid JSON object without any surrounding text or markdown. The JSON object must have the following structure:
{
  "broker_name": "Quantum Auto Finance",
  "agent_name": "e.g., 'Alex Cypher'",
  "agent_contact": {
    "email": "e.g., 'alex.c@qautofinance.ai'",
    "phone": "e.g., '+1 (555) 123-4567'"
  },
  "insurance_offer": {
    "provider": "e.g., 'Aura Insurance'",
    "annual_premium_eur": "e.g., '€1,850'",
    "coverage_highlights": [
      "Full Kasko (All-Risk) Coverage",
      "Theft and Vandalism Protection",
      "24/7 Roadside Assistance",
      "Glass Damage Included"
    ]
  },
  "financing_offer": {
    "provider": "e.g., 'Vector Leasing'",
    "monthly_rate_eur": "e.g., '€850'",
    "term_months": "e.g., '60'",
    "interest_rate_percent": "e.g., '4.5%'",
    "down_payment_eur": "e.g., '€15,000'"
  },
  "summary": "A brief, encouraging summary of the offer."
}
If a piece of information is not available, return "N/A" for strings, empty arrays [] for lists, or empty objects {} for maps.`;

        // We can re-use the vehicle search button for loading state, as it's not visible
        const result = await callGeminiAPI(prompt, document.createElement('button'));

        try {
            const data = JSON.parse(result);
            displayBrokerResults(data);
        } catch(e) {
            console.error("Failed to parse AI Broker response as JSON:", e, "Response was:", result);
            brokerResultsContainer.innerHTML = `<div class="col-span-1 md:col-span-2 p-4 bg-red-900/20 text-red-300 border border-red-500 rounded-lg">An error occurred while fetching broker offers. The AI returned an invalid format.</div>`;
        }
        
        brokerLoadingIndicator.style.display = 'none';
        brokerResultsContainer.classList.remove('hidden');
    }

    function displayBrokerResults(data) {
        brokerResultsContainer.innerHTML = '';
        
        let content = `
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white">${data.broker_name || 'AI Broker'}</h2>
                <p class="text-gray-500 dark:text-gray-400">Your personalized offers for the ${currentCar.year} ${currentCar.model}</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Insurance Card -->
                    <div class="gradient-border">
                        <div class="bg-white dark:bg-black rounded-lg p-6 h-full">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Insurance Offer</h3>
                            <div class="text-gray-600 dark:text-gray-300 space-y-4">
                                <div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">Annual Premium</div>
                                    <div class="text-3xl font-bold text-gray-900 dark:text-white">${data.insurance_offer.annual_premium_eur}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">Provider</div>
                                    <div class="text-lg font-semibold text-gray-900 dark:text-white">${data.insurance_offer.provider}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-2">Highlights</div>
                                    <ul class="space-y-1">
                                        ${data.insurance_offer.coverage_highlights.map(item => `<li class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>${item}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financing Card -->
                    <div class="gradient-border">
                        <div class="bg-white dark:bg-black rounded-lg p-6 h-full">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Financing Offer</h3>
                             <div class="text-gray-600 dark:text-gray-300 space-y-4">
                                <div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">Monthly Rate</div>
                                    <div class="text-3xl font-bold text-gray-900 dark:text-white">${data.financing_offer.monthly_rate_eur}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">Provider</div>
                                    <div class="text-lg font-semibold text-gray-900 dark:text-white">${data.financing_offer.provider}</div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong>Term:</strong> ${data.financing_offer.term_months} months</div>
                                    <div><strong>Interest:</strong> ${data.financing_offer.interest_rate_percent}</div>
                                    <div class="col-span-2"><strong>Down Payment:</strong> ${data.financing_offer.down_payment_eur}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Contact Card -->
                <div class="bg-gray-50 dark:bg-gray-800/50 p-6 rounded-xl border border-gray-200 dark:border-gray-700 h-full">
                     <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Your AI Agent</h3>
                     <div class="space-y-4">
                        <div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">Name</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">${data.agent_name}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">Email</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">${data.agent_contact.email}</div>
                        </div>
                         <div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">Phone</div>
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">${data.agent_contact.phone}</div>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 pt-4">${data.summary}</p>
                     </div>
                </div>
            </div>
        `;
        brokerResultsContainer.innerHTML = content;
    }

    function getCountryFlagEmoji(country) {
        const code = countryCodeMap[country];
        if (!code) return '';
        return String.fromCodePoint(...[...code.toUpperCase()].map(c => c.charCodeAt(0) + 127397));
    }

    function displayResultsAsCards(data) {
        resultsGrid.innerHTML = ''; 
        
        let cleanOrigin = data.origin || '';
        // Fix potential AI errors like "deGermany"
        for (const [countryName, code] of Object.entries(countryCodeMap)) {
            if (cleanOrigin.toLowerCase().includes(countryName.toLowerCase())) {
                cleanOrigin = countryName; // Standardize to the correct name, e.g., "Germany"
                break;
            }
        }
        
        const flag = getCountryFlagEmoji(cleanOrigin);
        resultOrigin.textContent = cleanOrigin ? `${flag} ${cleanOrigin}` : '';

        const createCard = (title, content, cardClasses = '') => {
            const cardWrapper = document.createElement('div');
            cardWrapper.className = `gradient-border ${cardClasses}`;
            cardWrapper.innerHTML = `<div class="bg-white dark:bg-black rounded-lg p-6 h-full flex flex-col"><h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">${title}</h3><div class="text-gray-600 dark:text-gray-300 flex-grow">${content}</div></div>`;
            return cardWrapper;
        };
        
        const createLockedCard = (title, cardClasses = '') => {
            const card = document.createElement('div');
            card.className = `bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl border border-dashed border-gray-300 dark:border-gray-700 flex items-center justify-between ${cardClasses}`;
            card.innerHTML = `
                <div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">${title}</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">This is a premium feature.</p>
                </div>
                <button class="premium-cta-btn animated-gradient text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    <span>Unlock</span>
                </button>
            `;
            card.querySelector('.premium-cta-btn').onclick = showPremiumModal;
            return card;
        };


        const createStat = (label, value, unit, iconSvg) => {
            if (!value || value === 'N/A') return '';
            return `<div class="text-center">${iconSvg}<div class="text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wider">${label}</div><div class="text-3xl font-bold text-gray-900 dark:text-white mt-1">${value}<span class="text-xl ml-1 font-medium text-gray-500 dark:text-gray-400">${unit}</span></div></div>`;
        };

        const createStarRating = (rating) => {
            const numRating = parseFloat(rating);
            if (isNaN(numRating)) return '<span>N/A</span>';
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= numRating) stars += `<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
                else stars += `<svg class="w-5 h-5 text-gray-300 dark:text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
            }
            return `<div class="flex items-center">${stars}<span class="ml-2 text-gray-500 dark:text-gray-400">${numRating.toFixed(1)}/5.0</span></div>`;
        };

        // --- FREE CARDS ---
        if (data.description) resultsGrid.appendChild(createCard('General Overview', `<p>${data.description}</p>`, 'md:col-span-2'));
        if (data.performance) {
            const powerIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 h-6 w-6 text-violet-400"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`;
            const speedIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 h-6 w-6 text-violet-400"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>`;
            const accelIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 h-6 w-6 text-violet-400"><circle cx="12" cy="13" r="8"/><path d="M12 9v4l2 1"/><path d="M5 3 2 6"/></svg>`;
            const statsContent = `<div class="flex justify-around items-start h-full space-x-4">${createStat('Power', data.performance.power_hp, 'HP', powerIcon)}${createStat('Top Speed', data.performance.top_speed_kmh, 'km/h', speedIcon)}${createStat('0-100 km/h', data.performance.acceleration_sec, 's', accelIcon)}</div>`;
            resultsGrid.appendChild(createCard('Performance', statsContent, 'md:col-span-2'));
        }
        if (data.price) {
            const content = `<div class="flex flex-col space-y-4"><div><div class="text-sm text-gray-500 dark:text-gray-400">Price (New)</div><div class="text-2xl font-bold text-gray-900 dark:text-white">${data.price.new_eur || 'N/A'}</div></div><div><div class="text-sm text-gray-500 dark:text-gray-400">Price (Used)</div><div class="text-2xl font-bold text-gray-900 dark:text-white">${data.price.used_eur || 'N/A'}</div></div></div>`;
            resultsGrid.appendChild(createCard('Price', content));
        }
        if (data.colors && data.colors.length > 0) {
            const colorsHtml = data.colors.map(c => `<div class="flex items-center"><span class="w-6 h-6 rounded-full border-2 border-white/20 mr-3" style="background-color: ${c.hex};"></span><span>${c.name}</span></div>`).join('');
            resultsGrid.appendChild(createCard('Available Colors', `<div class="flex flex-col space-y-2">${colorsHtml}</div>`));
        }
        if (data.modifications && data.modifications.length > 0) {
            const modsHtml = data.modifications.map(m => `<div><h4 class="font-semibold text-white">${m.name}</h4><p class="text-sm">${m.description}</p></div>`).join('');
            resultsGrid.appendChild(createCard('Popular Modifications', `<div class="space-y-3">${modsHtml}</div>`, 'md:col-span-2'));
        }
        if (data.part_prices && Object.keys(data.part_prices).length > 0) {
            const partsHtml = Object.entries(data.part_prices).map(([key, value]) => `<li class="flex justify-between"><span class="capitalize">${key.replace('_eur', '').replace('_', ' ')}</span><span class="font-semibold">${value}</span></li>`).join('');
            resultsGrid.appendChild(createCard('Common Part Prices', `<ul class="space-y-2">${partsHtml}</ul>`, 'md:col-span-2'));
        }
        if (data.tuning_versions && data.tuning_versions.length > 0) {
            const tuningHtml = data.tuning_versions.map(t => `<div><h4 class="font-semibold text-white">${t.tuner} - ${t.model_name}</h4><p class="text-sm">${t.description}</p></div>`).join('');
            resultsGrid.appendChild(createCard('Famous Tuning Versions', `<div class="space-y-4">${tuningHtml}</div>`, 'md:col-span-2'));
        }

        // --- PREMIUM CARDS ---
        if (isPremiumUser && data.expert_review) {
            resultsGrid.appendChild(createCard('Expert Review', `<p>${data.expert_review}</p>`, 'md:col-span-2'));
        } else {
            resultsGrid.appendChild(createLockedCard('Expert Review', 'md:col-span-2'));
        }
        
        if (isPremiumUser && data.rating) {
            resultsGrid.appendChild(createCard('Expert Rating', createStarRating(data.rating)));
        } else {
             resultsGrid.appendChild(createLockedCard('Expert Rating'));
        }
        
        if (isPremiumUser && data.price_history && data.price_history.length > 0) {
            const historyHtml = data.price_history.map(p => `<li class="flex justify-between"><span>${p.year}</span><span class="font-semibold">${p.price_eur}</span></li>`).join('');
            resultsGrid.appendChild(createCard('Price Over Time', `<ul class="space-y-2">${historyHtml}</ul>`));
        } else {
             resultsGrid.appendChild(createLockedCard('Price Over Time'));
        }
        
        if (isPremiumUser && data.full_analysis) {
            const analysisContent = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-white">Common Faults</h4>
                        <p class="text-sm">${data.full_analysis.common_faults}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-white">Maintenance Tips</h4>
                        <p class="text-sm">${data.full_analysis.maintenance_tips}</p>
                    </div>
                     <div>
                        <h4 class="font-semibold text-white">Service Contacts</h4>
                        <p class="text-sm">${data.full_analysis.service_contacts}</p>
                    </div>
                </div>
            `;
            resultsGrid.appendChild(createCard('Full AI Analysis', analysisContent, 'md:col-span-2'));
        } else {
             resultsGrid.appendChild(createLockedCard('Full AI Analysis', 'md:col-span-2'));
        }

        // --- BROKER CTA ---
        brokerCtaContainer.innerHTML = '';
        if(isPremiumUser) {
            const brokerBtn = document.createElement('button');
            brokerBtn.className = 'w-full max-w-sm mx-auto animated-gradient text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 flex items-center justify-center space-x-2';
            brokerBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span>Find AI Broker & Offers</span>
            `;
            brokerBtn.onclick = () => findBroker(currentCar);
            brokerCtaContainer.appendChild(brokerBtn);
        } else {
             const lockedBrokerBtn = document.createElement('div');
             lockedBrokerBtn.className = 'w-full max-w-sm mx-auto bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl border border-dashed border-gray-300 dark:border-gray-700 flex items-center justify-between';
             lockedBrokerBtn.innerHTML = `
                <div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">AI Broker & Offers</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Get personalized financing and insurance.</p>
                </div>
                <button class="premium-cta-btn animated-gradient text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    <span>Unlock</span>
                </button>
            `;
            lockedBrokerBtn.querySelector('.premium-cta-btn').onclick = showPremiumModal;
            brokerCtaContainer.appendChild(lockedBrokerBtn);
        }
    }

    // --- Local Storage Logic for Recent Cars ---
    function getRecentCars() { return JSON.parse(localStorage.getItem('recentCars')) || []; }

    function saveRecentCar(car) {
        let recentCars = getRecentCars();
        recentCars = recentCars.filter(c => !(c.brand === car.brand && c.model === car.model && c.submodel === car.submodel && c.year === car.year));
        recentCars.unshift(car);
        localStorage.setItem('recentCars', JSON.stringify(recentCars.slice(0, MAX_RECENT_CARS)));
    }

    function displayRecentCars() {
        const recentCars = getRecentCars();
        if (recentCars.length === 0) {
            recentCarsSection.classList.add('hidden');
            return;
        }
        recentCarsSection.classList.remove('hidden');
        recentCarsGrid.innerHTML = '';
        recentCars.forEach(car => {
            const card = document.createElement('button');
            card.className = 'bg-gray-100 dark:bg-gray-800 p-4 rounded-lg text-left hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors';
            card.innerHTML = `<div class="font-bold text-gray-900 dark:text-white">${car.brand} ${car.model}</div><div class="text-sm text-gray-500 dark:text-gray-400">${car.submodel} (${car.year})</div>`;
            card.onclick = () => {
                brandSelect.value = car.brand;
                brandSelect.dispatchEvent(new Event('change'));
                modelSelect.value = car.model;
                modelSelect.dispatchEvent(new Event('change'));
                submodelSelect.value = car.submodel;
                submodelSelect.dispatchEvent(new Event('change'));
                yearSelect.value = car.year;
                yearSelect.dispatchEvent(new Event('change'));
                currentCar = car;
                searchVehicle(currentCar);
            };
            recentCarsGrid.appendChild(card);
        });
    }

    async function callGeminiAPI(prompt, button) {
        const originalButtonText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = 'Searching...';

        try {
            const apiKey = "AIzaSyAVsgP4wvcrkhZchKlv3-5WJEqGW_i-fmU";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { throw new Error(`API call failed: ${response.status}`); }
            const result = await response.json();
            const candidate = result.candidates?.[0];
            let text = (candidate && candidate.content?.parts?.[0]?.text) ? candidate.content.parts[0].text : '{}';
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            return jsonMatch ? jsonMatch[0] : '{}';
        } catch (error) {
            console.error('Error calling Gemini API:', error);
            return `{"description": "An error occurred. Please check the console for details."}`;
        } finally {
            button.disabled = false;
            button.innerHTML = originalButtonText;
        }
    }
    
    // --- Dream Car Finder Logic ---
    function setupDreamCarFinder() {
        const carTypes = ['Hatchback', 'Sedan', 'Estate', 'SUV', 'Coupe', 'Convertible', 'Minivan', 'Pickup Truck', 'Sports Car', 'Supercar'];
        carTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            typeSelect.appendChild(option);
        });

        brands.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand;
            option.textContent = brand;
            brandSelectDream.appendChild(option);
        });
        
        const currentYear = new Date().getFullYear() + 1;
        for (let year = currentYear; year >= 1950; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelectDream.appendChild(option);
        }

        findDreamCarBtn.addEventListener('click', findDreamCar);
    }

    async function findDreamCar() {
        const criteria = {
            type: typeSelect.value,
            budget: budgetInput.value,
            brand: brandSelectDream.value,
            year: yearSelectDream.value,
        };

        switchPage('page-dreamcar-results');
        dreamcarLoadingIndicator.style.display = 'flex';
        dreamcarResultsGrid.classList.add('hidden');
        dreamcarResultsGrid.innerHTML = '';

        const prompt = `Act as a world-class car expert. A user is looking for their dream car based on some criteria. Your task is to recommend the top 3 best matching cars available on the market (new or used).
The user's criteria are:
- Car Type: ${criteria.type || 'Any'}
- Maximum Budget: ${criteria.budget ? `€${criteria.budget}` : 'Any'}
- Brand: ${criteria.brand || 'Any'}
- Minimum Year: ${criteria.year || 'Any'}

VERY IMPORTANT: Your response MUST be a single, valid JSON object without any surrounding text or markdown. The JSON object must have a key "recommendations" which is an array of exactly 3 car objects. Each car object must have the following structure:
{
  "brand": "e.g., 'Volkswagen'",
  "model": "e.g., 'Golf'",
  "submodel": "The most representative sub-model/trim for this recommendation, e.g., 'GTI'",
  "year": "A single, representative year from the year_range, e.g., '2019'",
  "year_range": "e.g., '2018-2020'",
  "price_eur": "e.g., '€23,000'",
  "type": "e.g., 'Hatchback'",
  "reasoning": "A short, compelling paragraph explaining why this car is a great match for the user's criteria, highlighting its key strengths."
}
Provide diverse and interesting recommendations.`;

        const result = await callGeminiAPI(prompt, findDreamCarBtn);
        
        try {
            const data = JSON.parse(result);
            displayDreamCarResults(data.recommendations || []);
        } catch (e) {
            console.error("Failed to parse Dream Car AI response as JSON:", e, "Response was:", result);
            dreamcarResultsGrid.innerHTML = `<div class="col-span-1 lg:col-span-3 p-4 bg-red-900/20 text-red-300 border border-red-500 rounded-lg">An error occurred while finding your dream car. The AI returned an invalid format.</div>`;
        }
        
        dreamcarLoadingIndicator.style.display = 'none';
        dreamcarResultsGrid.classList.remove('hidden');
    }

    function displayDreamCarResults(recommendations) {
        dreamcarResultsGrid.innerHTML = '';
        if (!recommendations || recommendations.length === 0) {
            dreamcarResultsGrid.innerHTML = `<div class="col-span-1 lg:col-span-3 text-center text-gray-500 dark:text-gray-400">The AI couldn't find any matches. Please try different criteria.</div>`;
            return;
        }

        recommendations.forEach(car => {
            const card = document.createElement('button');
            card.className = 'bg-gray-50 dark:bg-gray-800/50 p-6 rounded-xl border border-gray-200 dark:border-gray-700 flex flex-col text-left hover:border-violet-500 focus:outline-none focus:ring-2 focus:ring-violet-500 transition-all';
            
            const carName = `${car.brand} ${car.model}`;
            const placeholderImageUrl = `https://placehold.co/600x400/1a1a1a/ffffff?text=${encodeURIComponent(carName)}`;
            
            card.innerHTML = `
                <img src="${placeholderImageUrl}" alt="Image of ${carName}" class="w-full h-40 object-cover rounded-lg mb-4">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">${carName}</h3>
                <div class="text-sm text-gray-500 dark:text-gray-400 mb-3">${car.type} | ${car.year_range}</div>
                <div class="text-2xl font-bold text-gray-800 dark:text-white mb-4">${car.price_eur}</div>
                <p class="text-gray-600 dark:text-gray-300 text-sm flex-grow">${car.reasoning}</p>
            `;

            card.onclick = () => {
                if (car.brand && car.model && car.submodel && car.year) {
                    const carDetails = {
                        brand: car.brand,
                        model: car.model,
                        submodel: car.submodel,
                        year: car.year
                    };
                    currentCar = carDetails;
                    searchVehicle(carDetails);
                } else {
                    alert("Sorry, detailed information for this specific recommendation is not available.");
                    console.error("Missing detailed data from dream car recommendation:", car);
                }
            };

            dreamcarResultsGrid.appendChild(card);
        });
    }

    // --- Premium Modal Logic ---
    const premiumModal = document.getElementById('premium-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    
    function showPremiumModal() { premiumModal.classList.remove('hidden'); }
    function hidePremiumModal() { premiumModal.classList.add('hidden'); }

    closeModalBtn.addEventListener('click', hidePremiumModal);


    // Initial Setup
    displayRecentCars();
    setupDreamCarFinder();
    switchPage('page-home');
});
</script>

</body>
</html>


